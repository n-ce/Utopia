<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>PHIFOLD: RC-Build</title>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@8.1.0/dist/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/planck@1.4.2/dist/planck.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@15.1.22/build/Tone.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { width: 100%; height: 100%; background: #000; overflow: hidden; touch-action: none; }
        
        #canvas-container { 
            width: 100dvw; height: 100dvh; 
            display: flex; justify-content: center; align-items: center; 
        }
        
        /* Metaball Effect Layer */
        #liquid-fx { 
            filter: contrast(35) blur(12px); 
            width: 100%; height: 100%;
        }

        #ui { 
            position: fixed; bottom: 8%; width: 100%; text-align: center; 
            color: #444; font-family: monospace; letter-spacing: 0.4rem; 
            pointer-events: none; z-index: 100; font-size: 11px;
        }

        #intro {
            position: fixed; inset: 0; background: #000; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; font-family: monospace; color: #fff;
        }
    </style>
</head>
<body>

    <div id="intro" onclick="start()">
        <h1 style="letter-spacing: 1.5rem; font-weight: 100; margin-bottom: 20px;">PHIFOLD</h1>
        <p style="color:#333; letter-spacing: 0.2rem;">[ ENGAGE VOID ]</p>
    </div>
    
    <div id="canvas-container">
        <div id="liquid-fx"></div>
    </div>
    
    <div id="ui">CORE_STABILITY: <span id="idx" style="color:#888">0.000</span></div>

    <script>
        const { Vec2, World, Circle, DistanceJoint } = planck;
        const PHI = 1.61803398875;
        const THRESHOLD = Math.PI * PHI;
        const SCALE = 25; // Visual mapping scale

        let app, world, drone, synth, energy = 0, clusters = [], active = false;

        async function start() {
            try {
                // 1. Initialize Tone.js
                await Tone.start();
                document.getElementById('intro').remove();
                
                drone = new Tone.Oscillator(55 * PHI, "sine").toDestination().start();
                drone.volume.value = -30;
                synth = new Tone.MembraneSynth().toDestination();

                // 2. Initialize PIXI v8.1.0-rc
                app = new PIXI.Application();
                await app.init({ 
                    resizeTo: window,
                    backgroundColor: 0x000000,
                    antialias: true,
                    resolution: window.devicePixelRatio || 1
                });
                document.getElementById('liquid-fx').appendChild(app.canvas);

                // 3. Setup Physics
                world = new World(Vec2(0, 0));

                // 4. Genesis Center Mark
                const card = new PIXI.Graphics()
                    .rect(-40, -60, 80, 120)
                    .stroke({ width: 1, color: 0x111111 });
                card.x = app.screen.width / 2;
                card.y = app.screen.height / 2;
                app.stage.addChild(card);

                active = true;

                // 5. Lifecycle Loops
                app.ticker.add((ticker) => update(ticker.deltaMS));
                setInterval(() => { if(active && clusters.length < 12) spawn(); }, 1400);
                window.addEventListener('pointerdown', pulse);

                // Initial burst
                for(let i=0; i<4; i++) spawn();

            } catch (err) {
                console.error("Initialization Failed:", err);
            }
        }

        function spawn() {
            const angle = Math.random() * Math.PI * 2;
            const radius = 18; 
            const sx = Math.cos(angle) * radius;
            const sy = Math.sin(angle) * radius;
            
            const cluster = { bodies: [], graphics: [], mass: 0 };

            // Create unstable binary pairs
            for(let i = 0; i < 2; i++) {
                const mass = 0.35 + Math.random() * 0.5;
                const body = world.createDynamicBody({
                    position: Vec2(sx + (i * 0.5), sy),
                    linearDamping: 1.2,
                    angularDamping: 0.8
                });
                body.createFixture(Circle(mass * 0.6), { density: 1, friction: 0.1 });

                const g = new PIXI.Graphics().circle(0, 0, mass * 25).fill(0xffffff);
                app.stage.addChild(g);

                cluster.bodies.push(body);
                cluster.graphics.push(g);
                cluster.mass += mass;
            }

            world.createJoint(DistanceJoint({
                bodyA: cluster.bodies[0],
                bodyB: cluster.bodies[1],
                length: 0.8,
                frequencyHz: 4.0,
                dampingRatio: 0.2
            }));

            clusters.push(cluster);
        }

        function pulse(e) {
            if(!active) return;
            const px = (e.clientX - app.screen.width / 2) / SCALE;
            const py = (e.clientY - app.screen.height / 2) / SCALE;
            const pVec = Vec2(px, py);

            synth.triggerAttackRelease("A1", "32n");

            clusters.forEach(c => c.bodies.forEach(b => {
                const d = Vec2.sub(b.getPosition(), pVec);
                const dist = d.length();
                if (dist < 12) {
                    b.applyLinearImpulse(d.normalize().mul(12 / (dist + 1)), b.getWorldCenter());
                }
            }));
        }

        function update(dt) {
            if(!active) return;
            
            // Step physics based on frame delta
            world.step(1/60);

            const midX = app.screen.width / 2;
            const midY = app.screen.height / 2;

            clusters.forEach(c => {
                c.bodies.forEach((b, i) => {
                    const pos = b.getPosition();
                    const dist = pos.length();
                    
                    // Gravitational attraction
                    b.applyForceToCenter(Vec2(-pos.x, -pos.y).normalize().mul(2.2 * c.mass));

                    // Sync graphics to physics
                    const g = c.graphics[i];
                    g.x = midX + (pos.x * SCALE);
                    g.y = midY + (pos.y * SCALE);

                    // Energy collection at the core
                    if (dist < 6) energy += 0.015;
                });
            });

            // Scarcity entropy: energy decays over time
            energy = Math.max(0, energy - (Math.pow(energy, 1.3) * 0.006));
            const stability = Math.min(1, energy / THRESHOLD);
            
            document.getElementById('idx').innerText = stability.toFixed(3);
            
            // Sound modulation
            drone.frequency.value = (55 * PHI) + (stability * 220);
            drone.volume.value = -30 + (stability * 10);
        }
    </script>
</body>
</html>
