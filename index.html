<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PHIfold: Sonic Physics</title>
    <script src="https://cdn.jsdelivr.net/npm/planck@1.4.2/dist/planck.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@15.1.22/build/Tone.js"></script>
    <style>
        :root { --phi: 1.61803398875; }
        * { box-sizing: border-box; touch-action: none; user-select: none; }
        body { margin: 0; background: #000; color: #fff; font-family: monospace; overflow: hidden; height: 100dvh; display: flex; align-items: center; justify-content: center; }

        #void-wrap {
            position: relative;
            width: 100dvw; height: 100dvw;
            max-width: 100dvh; max-height: 100dvh;
            filter: contrast(28) blur(6px);
            background: radial-gradient(circle at center, #111 0%, #000 75%);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }

        #genesis-card {
            position: absolute;
            width: 18dvmin; height: 26dvmin;
            background: #fff;
            border-radius: 4px;
            z-index: 10;
        }

        .particle {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            will-change: transform;
            pointer-events: none;
        }

        #ui { position: fixed; bottom: 5dvh; width: 100%; text-align: center; z-index: 100; pointer-events: none; }
        #manifest-btn { pointer-events: auto; background: #fff; padding: 15px 35px; border: none; font-weight: bold; letter-spacing: 5px; display: none; cursor: pointer;}
        
        #intro { position: fixed; inset: 0; background: #000; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
    </style>
</head>
<body>

    <div id="intro" onclick="initAudio()">
        <h1 style="letter-spacing: 15px;">PHIFOLD</h1>
        <p style="color: #444;">TAP TO INITIATE SONIC FLOW</p>
    </div>
    
    <div id="void-wrap" onpointerdown="handleRepel(event)">
        <div id="genesis-card"></div>
    </div>

    <div id="ui">
        <button id="manifest-btn" onclick="manifest()">MANIFEST</button>
        <div style="margin-top: 15px; color: #333; font-size: 10px; letter-spacing: 3px;">
            STABILITY: <span id="e-pct">0</span>%
        </div>
    </div>

    <script>
        const { Vec2, World, Circle, Box, DistanceJoint } = planck;
        const world = new World({ gravity: Vec2(0, 0) });
        const PHI = 1.61803398875;
        const TARGET = Math.PI * PHI;
        
        let energy = 0, blobGroups = [], isActive = false;

        // --- AUDIO SETUP (Tone.js v15.1.22) ---
        let drone, splashSynth, filter;

        async function initAudio() {
            await Tone.start();
            document.getElementById('intro').style.display = 'none';
            isActive = true;

            // Low-pass filter for the drone to give it a "void" feel
            filter = new Tone.AutoFilter("4n").toDestination().start();
            
            // Background Drone
            drone = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: { attack: 2, release: 2 }
            }).connect(filter);
            drone.set({ volume: -20 });
            drone.triggerAttack(["E2", "B2"]);

            // Repel sound (Splash)
            splashSynth = new Tone.MetalSynth({
                frequency: 200,
                envelope: { attack: 0.01, decay: 0.2, release: 0.2 },
                harmonicity: 5.1,
                modulationIndex: 32,
                resonance: 4000,
                octaves: 1.5
            }).toDestination();
            splashSynth.volume.value = -15;

            run();
            setInterval(() => { if (isActive && blobGroups.length < 7) spawnMolecularBlob(); }, 1500);
        }

        // --- PHYSICS & LOGIC ---
        const cardBody = world.createBody();
        cardBody.createFixture({ shape: Box(1.0, 1.4) });

        function spawnMolecularBlob() {
            const angle = Math.random() * Math.PI * 2;
            const r = 9;
            const origin = Vec2(Math.cos(angle) * r, Math.sin(angle) * r);
            const cluster = { bodies: [], elements: [], mass: 0 };
            const numNodes = 3;

            for(let i = 0; i < numNodes; i++) {
                const nodeBody = world.createDynamicBody({
                    position: Vec2(origin.x + Math.random(), origin.y + Math.random()),
                    linearDamping: 1.5,
                    angularDamping: 0.5
                });

                const nodeMass = 0.2 + (Math.random() * 0.4);
                nodeBody.createFixture({ shape: Circle(nodeMass * 0.4), density: 1.0 });

                const el = document.createElement('div');
                el.className = 'particle';
                el.style.width = el.style.height = (nodeMass * 14) + 'dvmin';
                document.getElementById('void-wrap').appendChild(el);

                cluster.bodies.push(nodeBody);
                cluster.elements.push(el);
                cluster.mass += nodeMass;

                if (i > 0) {
                    world.createJoint(DistanceJoint({
                        bodyA: cluster.bodies[i-1], bodyB: nodeBody,
                        length: 0.5, frequencyHz: 2.0, dampingRatio: 0.5
                    }));
                }
            }
            blobGroups.push(cluster);
        }

        function handleRepel(e) {
            if (!isActive) return;
            const rect = document.getElementById('void-wrap').getBoundingClientRect();
            const clickVec = Vec2(((e.clientX - rect.left) / rect.width * 20) - 10, ((e.clientY - rect.top) / rect.height * 20) - 10);

            // Play "splash" sound
            splashSynth.triggerAttackRelease("C2", "16n");

            blobGroups.forEach(group => {
                group.bodies.forEach(body => {
                    const diff = Vec2(body.getPosition().x - clickVec.x, body.getPosition().y - clickVec.y);
                    if (diff.length() < 5) {
                        body.applyLinearImpulse(diff.normalize().mul(3.0), body.getWorldCenter());
                    }
                });
            });
        }

        function run() {
            if (!isActive) return;
            world.step(1/60);

            blobGroups.forEach(group => {
                group.bodies.forEach((body, bIdx) => {
                    const pos = body.getPosition();
                    body.applyForceToCenter(Vec2(-pos.x, -pos.y).normalize().mul(1.5 * group.mass));
                    group.elements[bIdx].style.transform = `translate(${pos.x * 5}dvmin, ${pos.y * 5}dvmin) translate(-50%, -50%)`;
                    if (pos.length() < 1.2) energy += 0.006;
                });
            });

            if (energy > 0) energy -= (Math.pow(energy, 1.4) * 0.005);
            const progress = Math.min(100, (energy / TARGET) * 100);
            document.getElementById('e-pct').innerText = Math.floor(progress);

            // Audio Modulation: Drone pitch rises with stability
            if (drone) {
                const pitchShift = progress * 2; // Range 0 to 200 cents
                drone.set({ detune: pitchShift });
                filter.baseFrequency = 200 + (progress * 5);
            }

            if (energy >= TARGET) document.getElementById('manifest-btn').style.display = 'inline-block';
            else document.getElementById('manifest-btn').style.display = 'none';

            requestAnimationFrame(run);
        }

        function manifest() {
            isActive = false;
            drone.releaseAll();
            new Tone.Oscillator(440, "sine").toDestination().start().stop("+0.5");
            document.getElementById('void-wrap').style.filter = 'none';
            document.getElementById('genesis-card').style.transition = 'all 1s ease';
            document.getElementById('genesis-card').style.transform = 'scale(0.2) translate(-200%, 200%)';
            setTimeout(() => alert("PHIFOLD STABILIZED"), 1000);
        }
    </script>
</body>
</html>
