<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>PHIFOLD: Kinetic Genesis</title>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@8.1.0/dist/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/planck@1.4.2/dist/planck.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@15.1.22/build/Tone.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { width: 100%; height: 100%; background: #000; overflow: hidden; touch-action: none; }
        #canvas-container { width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        /* The Secret Sauce: Liquid CSS Filter */
        canvas { filter: contrast(35) blur(12px); background: #000; }

        #ui { 
            position: fixed; bottom: 8%; width: 100%; text-align: center; 
            color: #555; font-family: 'Courier New', monospace; letter-spacing: 0.3rem; 
            pointer-events: none; z-index: 100; font-size: 10px;
        }
        #intro {
            position: fixed; inset: 0; background: #000; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; font-family: monospace; color: #fff;
        }
        #intro h1 { letter-spacing: 1.5rem; font-weight: 100; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="intro" onclick="start()">
        <h1>PHIFOLD</h1>
        <p style="color:#444; letter-spacing: 0.5rem;">[ CLICK TO OBSERVE ]</p>
    </div>
    
    <div id="canvas-container"></div>
    
    <div id="ui">
        CORE_STABILITY: <span id="idx" style="color:#888">0.000</span>
    </div>

    <script>
        const { Vec2, World, Circle, DistanceJoint } = planck;
        const PHI = 1.61803398875;
        const THRESHOLD = Math.PI * PHI;
        const P_SCALE = 15; // 1 Planck meter = 15 Pixi pixels
        
        let app, world, drone, synth, energy = 0, clusters = [], active = false;
        let horizon;

        async function start() {
            await Tone.start();
            document.getElementById('intro').remove();
            
            // Audio: FM Drone for richer "void" texture
            drone = new Tone.FMSynth({
                harmonicity: 3, modulationIndex: 10,
                oscillator: { type: "sine" },
                envelope: { attack: 2 }
            }).toDestination();
            drone.volume.value = -30;
            drone.triggerAttack("E2");

            synth = new Tone.MembraneSynth().toDestination();

            // PIXI v8 Setup
            app = new PIXI.Application();
            await app.init({ 
                width: 800, height: 800, 
                backgroundColor: 0x000000,
                antialias: true,
                resolution: window.devicePixelRatio || 1
            });
            document.getElementById('canvas-container').appendChild(app.canvas);

            world = new World(Vec2(0, 0));

            // Stability Horizon (The Ring)
            horizon = new PIXI.Graphics();
            app.stage.addChild(horizon);

            // Genesis Card Reference
            const card = new PIXI.Graphics()
                .rect(-45, -65, 90, 130)
                .stroke({ width: 2, color: 0x111111 });
            card.x = 400; card.y = 400;
            app.stage.addChild(card);

            active = true;
            app.ticker.add(update);
            
            // Spawner
            setInterval(() => { if(clusters.length < 12) spawn(); }, 1500);

            // Kinetic Interaction
            app.canvas.addEventListener('pointerdown', pulse);
        }

        function spawn() {
            const angle = Math.random() * Math.PI * 2;
            const dist = 25; // Planck meters
            const origin = Vec2(Math.cos(angle) * dist, Math.sin(angle) * dist);
            const cluster = { bodies: [], graphics: [], mass: 0 };

            // Create a "Double-Node" Molecular Spark
            for(let i = 0; i < 2; i++) {
                const m = 0.4 + (Math.random() * 0.5);
                const b = world.createDynamicBody({ 
                    position: Vec2(origin.x + i, origin.y), 
                    linearDamping: 1.5,
                    angularDamping: 1.0
                });
                b.createFixture(Circle(m * 0.6), { density: 1, friction: 0.1 });

                const g = new PIXI.Graphics().circle(0, 0, m * 25).fill(0xffffff);
                app.stage.addChild(g);

                cluster.bodies.push(b);
                cluster.graphics.push(g);
                cluster.mass += m;

                if(i > 0) {
                    world.createJoint(DistanceJoint({
                        bodyA: cluster.bodies[0], bodyB: b,
                        length: 1.0, frequencyHz: 3.0, dampingRatio: 0.1
                    }));
                }
            }
            clusters.push(cluster);
        }

        function pulse(e) {
            if(!active) return;
            const rect = app.canvas.getBoundingClientRect();
            const px = ((e.clientX - rect.left) / rect.width * 53.33) - 26.66;
            const py = ((e.clientY - rect.top) / rect.height * 53.33) - 26.66;
            const pVec = Vec2(px, py);

            synth.triggerAttackRelease("G1", "16n");

            clusters.forEach(c => c.bodies.forEach(b => {
                const d = Vec2.sub(b.getPosition(), pVec);
                const len = d.length();
                if(len < 15) {
                    b.applyLinearImpulse(d.normalize().mul(20 / (len + 1)), b.getWorldCenter());
                }
            }));
        }

        function update(ticker) {
            if(!active) return;
            
            // Standardizing time step
            world.step(1/60);
            const time = performance.now() * 0.005;

            clusters.forEach(c => {
                c.bodies.forEach((b, i) => {
                    const pos = b.getPosition();
                    const dist = pos.length();
                    
                    // Gravitational Pull towards Center (0,0)
                    b.applyForceToCenter(Vec2(-pos.x, -pos.y).normalize().mul(3.0 * c.mass));

                    // Sync Visuals
                    const g = c.graphics[i];
                    // Fluctuating geometry
                    const pulse = Math.sin(time + (clusters.indexOf(c) * PHI)) * 5;
                    g.width = g.height = (c.mass * 25) + pulse;

                    // Map Planck meters to Pixi Pixels
                    g.x = 400 + (pos.x * P_SCALE);
                    g.y = 400 + (pos.y * P_SCALE);

                    // Stability Gathering
                    if (dist < 8) energy += 0.012;
                });
            });

            // Entropy Decay
            energy = Math.max(0, energy - (Math.pow(energy, 1.4) * 0.005));
            const stability = Math.min(1, energy / THRESHOLD);
            document.getElementById('idx').innerText = stability.toFixed(3);
            
            // Visual Event Horizon logic
            horizon.clear()
                .circle(400, 400, 100 + stability * 50)
                .stroke({ width: 1, color: 0x222222 + (Math.floor(stability * 200) << 16) });

            // Audio Modulation
            drone.detune.value = stability * 400;
        }
    </script>
</body>
</html>
